<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-firestore.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Images/Logo.png"/>

    <title>Sahara Meet</title>
    <style>
        .switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}
button{
    outline: none;
}
.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
    </style>
<body id="body" style="background-color: black;">
    <div id="fghj" style="display: none;">
        <div  id="rfg">
            <img style="width: 664px; height: 650px; position: relative;" src="" alt="">
            <img id="9UPbSTTGhKT8qr6yui0pFZ" style="width: 664px; height: 650px; position: relative;" src="" alt="">
        </div>
        <button id="cm" style="border: none; background-color: white; border-radius: 50px; width: 94px; height: 94px; position: absolute; top: 500px; left: 500px;" ><img id="sdf"  style="margin-top: 5px; width:74px; height: 74px;" src="Images/cameraon.png" alt=""></button>
        <button id="declinse" style="border: none; background-color: transparent; width: 104px; height: 104px; position: absolute; top: 500px; left: 610px;"><img style="width: 94px; height: 94px;"  src="Images/6bf209c1-4d10-491a-812d-8a7c03798eea_200x200.png" alt=""></button> 
        <button id="mo" style="border: none; background-color: white; border-radius: 50px; width: 94px; height: 94px; position: absolute; top: 500px; left: 720px;"><img id="eaa" style="width: 54px; height: 54px;"  src="Images/unmute.png" alt=""></button> 
        <video width="270px" height="300px" style="position: absolute; top: 363px; left: 1070px;" id="video" muted></video>
        <canvas style="display: none;" id="canvas" ></canvas>
        <h1 id="fggggg" style="color:blue;"></h1>
        <audio id="asfliuv" src=""></audio>
    </div>
    <div id="gh">
        <div>
            <div style="margin-left: 560px; margin-top: 200px; width: 270px; ">
                <div style="background-color:rgb(0, 0, 53); height: 250px; border-radius: 20px;">
                    <div style="margin-left: 10px; ">
                        <img id="abc" style=" width: 40px; height: 40px; margin-top: 35px; margin-left: 20px; "  src="Images/cameraoff.png" alt="">
                        <img id="xyz" style=" width: 40px; height: 40px; margin-left: 110px;" src="Images/mute.png" alt="">
                       
                        <br>
                        
                        <label style="margin-top: 10px; margin-left: 15px;" class="switch">
                    <input id="hgfd" type="checkbox">
                    <span class="slider round"></span>
                  </label>
                 
                  
                  <label   style="margin-left: 90px;"  class="switch">
                    <input id="hgfdp" type="checkbox">
                    <span class="slider round"></span>
                  </label>
                  <button style=" margin-top: 20px; border-radius: 22px;  background-color: rgb(185, 185, 185); outline: white; width: 250px; height: 80px;" id="y">Join</button>
                    </div>
                    
                </div>
                 <div id="rgg">

                 </div>
                </div>
                <audio id="vpn" ></audio>
            <div id="yg">

            </div>
           

            
           
        </div>
        
        
    </div>
    
</body>
<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
<script>
    var firebaseConfig = {
            apiKey: "AIzaSyCoK1APEkbi7HzfGekPgAVX8l8q6BLmL50",
            authDomain: "sahara-8bfbe.firebaseapp.com",
            databaseURL: "https://sahara-8bfbe.firebaseio.com",
            projectId: "sahara-8bfbe",
            storageBucket: "sahara-8bfbe.appspot.com",
            messagingSenderId: "247681289351",
            appId: "1:247681289351:web:c75c7b2fc405a19e1e3c22",
            measurementId: "G-Q1E5WQHV8G"
        };

        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();
        URL = window.URL || window.webkitURL;
    
    
    
    const hgfd = document.getElementById('hgfd');
    const hgfdp = document.getElementById('hgfdp');
    const abc = document.getElementById('abc')
    const xyz = document.getElementById('xyz')
    var gumStream;
    let mlk = true
    var rec;
    var input;
    const y = document.getElementById('y')
    const cm = document.getElementById('cm')
    const mo = document.getElementById('mo')
    let fg = 0;
    let mlop = 1
    const declinse = document.getElementById('declinse')
    const gh = document.getElementById('gh')
    const sdf = document.getElementById('sdf')
    const eaa = document.getElementById('eaa')
    const yg = document.getElementById('yg')
    hgfd.checked = false
    hgfdp.checked = true
    abc.src =  "Images/cameraoff.png"
    hgfd.addEventListener('change', function(){
        
        if(hgfd.checked == true){

            abc.src =  "Images/cameraon.png"
        }else{
            abc.src =  "Images/cameraoff.png"
        }
    });
    hgfdp.addEventListener('change', function(){
       
        
        if(hgfdp.checked == true){
          
            xyz.src = "Images/mute.png"
        }else{
           
            xyz.src = "Images/unmute.png"
        }
    });
    const rfg = document.getElementById('rfg')
    const ref = firestore.collection(sessionStorage.getItem('Chat_Name')).doc("Chat_Info");
    let user = localStorage.getItem('user')
   
    let chatinfo = sessionStorage.getItem('Chat_Name')
    declinse.addEventListener('click', function(){
        firestore.collection(chatinfo).doc("Chat_Info").get().then(snapshot=>{
           
            let data = snapshot.data()
            const pim = data.pim
            let rfgklom = pim.split("/")
            const index = rfgklom.indexOf(user);
            if(rfgklom[0] == user && rfgklom[1] == ""){
                
                firestore.collection(chatinfo).doc("Chat_Info").update({
                pim: ""
            }) 
           
            }else{
                if(rfgklom.length != 1){
                if (index > -1) {
                let ygio = rfgklom.splice(index, 1);
                console.log(ygio)
                firestore.collection(chatinfo).doc("Chat_Info").update({
                pim: ygio.join("")
            })
            }

            }
            
                           
            }
            
            close("html.html")
           
        })
        
    })
    const fghj = document.getElementById('fghj')
    var constraints = { audio: true,
                        video: false};
    y.addEventListener('click', ()=>{
        var AudioContext = window.AudioContext || window.webkitAudioContext;
        var audioContext = new AudioContext;
        startup()
        gh.style.display = "none"
        fghj.style.display = "block"
        let camera = document.getElementById('hgfd').checked
       sessionStorage.setItem("camera", camera)
        let mute = document.getElementById('hgfdp').checked
        sessionStorage.setItem("mute", mute)
        if(camera == true){
            sdf.src =  "Images/cameraon.png"
        }else{
            sdf.src =  "Images/cameraoff.png"
        }
        if(mute == true){
            eaa.src = "Images/mute.png"
        }else{
            eaa.src = "Images/unmute.png"
        }
    
   
    ref.onSnapshot(function(docl){
        const dat = docl.data();
        let fg = dat.pim;

        makeframe(fg)
    })
    function makeframe(i){
        rfg.innerHTML = ""
        let g = i.split("/")
        let mp = g.length
        if(g.length == 2 && g[1] == ""){
            mp = 1
        }
        if(mp == 0){
          
            firestore.collection(sessionStorage.getItem('Chat_Name')).doc("Chat_Info").update({
                Iscall: false
            });
            firestore.collection(sessionStorage.getItem('Chat_Name')).doc("Chat_Info").get().then(s=>{
                let fg = s.data()
                console.log(fg.Iscall)
            })
        }
        for (let o = 0; o < mp; o++) {
           
            const element = g[o];
            let h = g.length
           
            if(element != ""){
                let fh = 1330/mp
                let asc = "audio" + element
               
               const audiolkk  =  `<audio id="${asc}"></audio>`
               document.getElementById('rgg').innerHTML += audiolkk
                let uj = `<img id="${element}" style="width: ${fh + "px"}; height: 650px; position: relative;" src="" alt="">`
                rfg.innerHTML += uj
               
                
            }
             fiy()
            
        }

    }
    if(mlop == 1){
        firestore.collection('users').doc(user).update({
                camera: "false",
                mute: "true"
    })
    }
    mlop = 0
    
    function fiy(){
        let insatp = true
        let fy = setInterval(function(){
            if(fg == 0){
                var context = canvas.getContext('2d');
            let width = canvas.width ;
            let height = canvas.height
            canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);

                var data = canvas.toDataURL('image/png');
                if(mlk == true){
                    firestore.collection('users').doc(user).update({
                    webcame: data
                })

                }else{
                   
         
            let gh = sessionStorage.getItem('camera')
            let rf = sessionStorage.getItem('mute')
          
            firestore.collection('users').doc(user).update({
                camera: gh,
                mute: rf
            })
            
            
            firestore.collection('users').doc(user).get().then(s=>{
                const gh = s.data()
               
            })        
                }
                
                setTimeout(function(){
                    firestore.collection(chatinfo).doc("Chat_Info").get().then(snapshot=>{
                    let rf = snapshot.data();
                    let ft = rf.pim;
                    let rp = ft.split("/");
                   
                    for (let i = 0; i < rp.length; i++) {
                        
                        const element = rp[i];
                      
                        
                        
                        
                        if(element.trim() != ""){
                          
                            firestore.collection('users').doc(element).get().then(snapshot=>{
                            
                                const data = snapshot.data();
                            
                            let fg = data.camera
                           
                            let fi = data.Profile
                            let hj = data.mute
                           
                           
                            
                                          
                            if(fg == "true"){
                               
                                let ro = data.webcame;
                                document.getElementById(user).src = ro;

                            }else{
                                document.getElementById(user).src = fi  
                            }
                            
                        })
                        }
                        
                        
                    }
                    
                    });

                }, 10)
                

            }else{
                setTimeout(function(){
                    fg = 0
                }, 600)
                
            }
            
                
            
        }, 15)
    }
    let bncv = 0
    
   setInterval(function(){
      
    try{
      
    firestore.collection(chatinfo).doc("Chat_Info").get().then(snapshot=>{
       
        let rf = snapshot.data();
                    let ft = rf.pim;
                    let rp = ft.split("/");
                   
                    for (let i = 0; i < rp.length; i++) {
                        
                        const element = rp[i];

         if(element != ""){
            firestore.collection("users").doc(element).get().then(s=>{
            let insatp = true
            let data = s.data();
            let op = s.id
            let mute = data.mute
            let audio = data.sound
        if(op == user){
                                ///////////////////////////////////////////////////////////////////////////////
                                //////////////////////////////////////////////////////////////////
                                //////////////////////////////////////////////////////////////////
                                /////////////////////////////////////////////////////////////////////
                                //CHANGE to !=
                                
                                let fgh = "audio" + op 
                                  
                                if(mute != "true"){
                                   
                                   setTimeout(function(){
                                       let ghopppppmlk = "ededed"
                                       
                                            const  jjj = (fgh, audio)=>{
       
                                                        document.getElementById(fgh).src = "data:audio/wav;base64," + audio;
                                                        
                                                    
                                            }
                                             jjj(fgh, audio).then(()=>{
                                                ghopppppmlk = "no tsued just ghh "
                                             }).catch(error=>{
                                                ghopppppmlk = "hey hyhyhyhyhyhyhooppppp"
                                             })
                                       

                                       
                                       
                                        
                                       
                                     
                                    
                                        if(insatp == true){
                                            
                                            
                                            setTimeout(function(){
                                                if(bncv == 0){
                                                   
                                                    bncv = 1
                                                    setTimeout(function(){
                                                        
                                                    }, 2050)
                                                    
                                                }else{
                                                    bncv = 0
                                                }
                                               
                                            }, 543)
                                            if(bncv == 1){
                                               
                                                bncv = 0
                                                document.getElementById(fgh).play()
                                            }else{
                                                bncv = 1
                                            }
                                            
                                            }

                                   }, 143)
                                   
                                }else{ 
                                    setTimeout(function(){
                                    let ghj = "ed"
                                },841)
                                }
                                
                            
                                
                            }
    
        })

         } 
         
                    }
    
       
    })
}catch(e){
    console.log("eeeeeeeeeeeeeeeeeeee")
}
   },100) 
 
   
    cm.addEventListener('click', function(){
        mlk = false
       
            let camerais = sessionStorage.getItem("camera")
           
           
            if(camerais == "true"){
               
                sessionStorage.setItem("camera","false")
                sdf.src = "Images/cameraoff.png"
            }else{
                sessionStorage.setItem("camera","true")
                sdf.src = "Images/cameraon.png"

            }
           
           firestore.collection('users').doc(user).update({
               camera: sessionStorage.getItem('camera')
           })
          
            setTimeout(function(){
                mlk = true
            }, 200)
            
        })
        mo.addEventListener('click', function(){
            
           mlk = false
            let muteis = sessionStorage.getItem("mute")
            if(muteis == "true"){
                sessionStorage.setItem("mute","false")
                eaa.src = "Images/unmute.png"
            }else{
                sessionStorage.setItem("mute","true")
                eaa.src = "Images/mute.png"
            }
            firestore.collection('users').doc(user).update({
               mute: sessionStorage.getItem('mute')
           })
           
            setTimeout(function(){
                mlk = true
            }, 200)
        })
        
        
    function startup() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    // access video stream from webcam  
        // on success, stream it in video tag
        navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
        }).then(function(stream) {
           
            video.srcObject = stream;
            setInterval(function(){
                firestore.collection('users').doc(user).get().then(snapshot=>{
                    const g = snapshot.data()
                    let fkk = g.camera
                   
                    if(fkk != "false"){
                      
                    video.style.display = "block"
                    video.play();
            }else{
                
                    video.style.display = "none"
            }
                });
                

            }, 10)
            
            
        })
        .catch(function(err) {
            console.log("An error occurred: " + err);
        });   
}

    setTimeout(function(){
        navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
            setInterval(() => {
                input = audioContext.createMediaStreamSource(stream);
    
        rec = new Recorder(input, {
            numChannels: 1
        }) 
        
        rec.record()
        setTimeout(event =>{
            rec.stop(); //stop microphone access 
    
            rec.exportWAV(createDownloadLink);
        }, 100)
                
            }, 160);
    })
   }, 
   41)
    })
    function createDownloadLink(blob) {
   
    if(sessionStorage.getItem("mute") == "false"){
        
        var url = URL.createObjectURL(blob);
    var reader = new FileReader();
    reader.onload = function() {
        var dataUrl = reader.result;
        var base64 = dataUrl.split(',')[1];
      
       
           
            firestore.collection('users').doc(user).update({
            sound: base64
        });
        
        
       
        
    };
    reader.readAsDataURL(blob);    
    }
} 
</script>
</html>